[gd_scene format=3 uid="uid://bw11r1q8awk8d"]

[sub_resource type="CSharpScript" id="CSharpScript_3td1k"]
script/source = "using Godot;
using System.Collections.Generic;

public partial class InventoryManager : Control
{
    // ui variables
    [Export] public VBoxContainer ItemsColumn;
    [Export] public Button CraftRepairPartButton;
    [Export] public Button CraftFuelRodButton;
    [Export] public Button CraftOxygenTankButton;
    [Export] public Button ConsumeOxygenButton; 

    // references
    [Export] public Player PlayerNode;

    // data variables
    private Dictionary<string, int> _inventory = new Dictionary<string, int>();

    // initialization functions
    public override void _Ready()
    {
        CraftRepairPartButton.Pressed += CraftRepairPart;
        CraftFuelRodButton.Pressed += CraftFuelRod;
        CraftOxygenTankButton.Pressed += CraftOxygenTank;
        ConsumeOxygenButton.Pressed += ConsumeOxygen;
        UpdateUI();
    }

    // inventory functions
    public void AddItem(string itemName, int amount)
    {
        if (_inventory.ContainsKey(itemName))
            _inventory[itemName] += amount;
        else
            _inventory[itemName] = amount;
        
        UpdateUI();
        CheckWinCondition();
    }

    public void RemoveItem(string itemName, int amount)
    {
        if (_inventory.ContainsKey(itemName))
        {
            _inventory[itemName] -= amount;
            if (_inventory[itemName] <= 0)
                _inventory.Remove(itemName);
        }
    }

    private bool HasItems(string item1, int amount1, string item2, int amount2)
    {
        int count1 = _inventory.ContainsKey(item1) ? _inventory[item1] : 0;
        int count2 = _inventory.ContainsKey(item2) ? _inventory[item2] : 0;
        return count1 >= amount1 && count2 >= amount2;
    }

    private bool HasItems(string item1, int amount1, string item2, int amount2, string item3, int amount3)
    {
        int count1 = _inventory.ContainsKey(item1) ? _inventory[item1] : 0;
        int count2 = _inventory.ContainsKey(item2) ? _inventory[item2] : 0;
        int count3 = _inventory.ContainsKey(item3) ? _inventory[item3] : 0;
        return count1 >= amount1 && count2 >= amount2 && count3 >= amount3;
    }

    // crafting functions
    private void CraftRepairPart()
    {
        if (HasItems(\"Copper\", 1, \"Titanium\", 1))
        {
            RemoveItem(\"Copper\", 1);
            RemoveItem(\"Titanium\", 1);
            AddItem(\"Repair Part\", 1);
        }
    }

    private void CraftFuelRod()
    {
        if (HasItems(\"Uranium\", 1, \"Ice\", 1))
        {
            RemoveItem(\"Uranium\", 1);
            RemoveItem(\"Ice\", 1);
            AddItem(\"Fuel Rod\", 1);
        }
    }

    private void CraftOxygenTank()
    {
        if (HasItems(\"Ice\", 1, \"Hematite\", 1, \"Titanium\", 1))
        {
            RemoveItem(\"Ice\", 1);
            RemoveItem(\"Hematite\", 1);
            RemoveItem(\"Titanium\", 1);
            AddItem(\"Oxygen Tank\", 1);
        }
    }

    private void ConsumeOxygen()
    {
        if (_inventory.ContainsKey(\"Oxygen Tank\") && _inventory[\"Oxygen Tank\"] > 0)
        {
            RemoveItem(\"Oxygen Tank\", 1);
            if (PlayerNode != null)
            {
                PlayerNode.AddOxygen(30f);
            }
            UpdateUI();
        }
    }

    // ui functions
    private void UpdateUI()
    {
        foreach (Node child in ItemsColumn.GetChildren())
        {
            child.QueueFree();
        }

        foreach (var kvp in _inventory)
        {
            Label itemLabel = new Label();
            itemLabel.Text = $\"{kvp.Key}: {kvp.Value}\";
            ItemsColumn.AddChild(itemLabel);
        }

        CraftRepairPartButton.Disabled = !HasItems(\"Copper\", 1, \"Titanium\", 1);
        CraftFuelRodButton.Disabled = !HasItems(\"Uranium\", 1, \"Ice\", 1);
        CraftOxygenTankButton.Disabled = !HasItems(\"Ice\", 1, \"Hematite\", 1, \"Titanium\", 1);
        
        ConsumeOxygenButton.Disabled = !(_inventory.ContainsKey(\"Oxygen Tank\") && _inventory[\"Oxygen Tank\"] > 0);
    }

    // game state functions
    private void CheckWinCondition()
    {
        int repairParts = _inventory.ContainsKey(\"Repair Part\") ? _inventory[\"Repair Part\"] : 0;
        int fuelRods = _inventory.ContainsKey(\"Fuel Rod\") ? _inventory[\"Fuel Rod\"] : 0;

        if (repairParts >= 3 && fuelRods >= 3)
        {
            GD.Print(\"YOU WIN!\");
        }
    }
}"

[node name="InventoryManager" type="Control" unique_id=564353495]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("CSharpScript_3td1k")

[node name="VBoxContainer" type="VBoxContainer" parent="." unique_id=1171886256]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
